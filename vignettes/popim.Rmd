---
title: "popim"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{popim}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(popim)
```

The intention of the package `popim` is to provide tools to easily
evaluate and track the POPulation IMmunity of an age-structured
population that results from vaccination. Given that vaccination has
long lasting effects, this requires tracking the status of the
population through time.

## Data structures

To this end the package defines two S3 classes to store data in an
appropriate format. Both classes are dataframes, but have additional
requirements such as certain columns that must be present, and the
format and range of these columns.

### S3 class `popim_population`

The class `popim_population` is designed to hold information on a
population of interest.

#### The dataframe

The dataframe holds information on the population size and immunity
status of the population through time. The population is disaggregated
into 1-year age groups, and potentially several spatial regions. Each
row refers to a particular (1 year) birth cohort in a given location
and year.

The mandatory columns are:

* `region`: The population of interest may be spatially
  disaggregated into separate geographical regions (e.g., countries or
  subnational administrative regions). This column holds a string that
  identifies which region each entry refers to.
* `year`: The population is tracked through time using annual time
  steps.
* `age`: The age-structure of the population is tracked in annual age
  groups.
* `cohort`: This column is redundant as it equals `year` - `age`, and
  therefore refers to the year in which this cohort was born. It is
  included for ease of handling.
* `immunity`: Gives the proportion of each cohort that is immune due
  to past vaccination.
* `pop_size`: Number of people in any given age group and year. To
  facilitate using common units such as thousands this is not limited
  to integer values. It is however up to the user to ensure that such
  units are used consistently.
  
| column     | type      | range          |
|------------|-----------|----------------|
| `region`   | character |                |
| `year`     | integer   |                |
| `age`      | integer   | non-negative   |
| `cohort`   | integer   | `year` - `age` |
| `immunity` | numeric   | [0, 1]         |
| `pop_size` | numeric   | non-negative   |



#### Class attributes

In addition to the attributes that every dataframe has (`names`,
`class`, `row.names`), the objects of the `popim_population` class
also retain the input parameters of the basic constructor
`popim_population()`:

* `region`: a character vector of all regions in this object,
* `year_min` and `year_max`: the range of years, and
* `age_min` and `age_max`: the age range covered in this population.


#### Create, modify and validate objects of this class

create: `popim_population()`, `read_popim_pop()`, `as_popim_pop()`

modify: `apply_vacc()`

validate: `is_population()`




### S3 class `popim_vacc_activities`

The class `popim_vacc_activities` is designed to hold information on
vaccination activities that have occurred or are planned in the
population of interest. Each row of the dataframe relates to one
vaccination activity.

#### The dataframe

The mandatory columns are:

* `region`: The region in which the vaccination activity takes
  place. While this is a free character field, when applied to a
  population, this must match a region that occurs in the population.
* `year`: year during which the vaccination activity takes place.
* `age_first`: youngest age group to be targeted.
* `age_last`: oldest age group to be targeted.
* `coverage`: proportion of the target population to be immunised.
* `doses`: number of doses used in the vaccination activity.
* `targeting`: determines how doses are allocated when there is
  pre-existing immunity in the population.

| column      | type      | range             |
|-------------|-----------|-------------------|
| `region`    | character |                   |
| `year`      | integer   |                   |
| `age_first` | integer   | non-negative      |
| `age_last`  | integer   | $\ge$ `age_first` |
| `coverage`  | numeric   | [0, 1]            |
| `doses`     | numeric   | non-negative      |
| `targeting` | character | `"random"`, `"correlated"`, `"targeted"` |

##### Relationship between coverage, doses and target population

*to do*

#### Class attributes

As this is a subclass of dataframe, it has the same attributes as a
dataframe (`names`, `class` and `row_names`). It has no additional
attributes.

#### Create and validate objects of this class

create: `popim_vacc_activities()`, `read_vacc_activities()`,
`as_vacc_activities()`, `vacc_from_immunity()`

modify: `complete_vacc_activities()`

validate: `validate_vacc_activities()`

## Primary functionality: applying vaccination activities to a population

Once objects holding data on the population and vaccination activities
have been set up, the primary functionality provided by `popim` is to
apply the vaccination activities to the population to evaluate the
population immunity by age over time that results from the given
vaccination activities, which is done with the function
`apply_vacc()`.

### Assumptions when applying vaccination activities to the population

* 100% vaccine effectiveness
* no wastage of doses
* no waning immunity
* mortality is independent of immunity status

While the first two are clearly unrealistic assumptions, if there is a
constant vaccine effectiveness (<100%), or a constant wastage factor,
the results can easily be scaled up by these constant factors to
obtain more realistic values for vaccine demand.

For a potentially deadly disease one would expect that mortality due
to the disease would be strongly correlated with immunity status,
however, even the most devastating outbreaks typically only affect a
small part of the population, and therefore all-cause mortality will
be much less impacted by mortality due to the specific disease. This
means that this assumption is closer to reality than it might appear
at first.

Waning immunity is a potentially important factor to consider for many
vaccines, particularly when looking at the long term benefits of
vaccination. However, allowing for this is currently not implemented.

### Description of the algorithm

The vaccination activities object has columns for `coverage`, the
proportion of the target population that will be vaccinated, and
`doses`, the number of vaccine doses to be administered in the
activity. Given a target population size this is redundant (and
potentially conflicting) information. The function `apply_vacc()` will
always use `coverage` information in preference over `doses`, if this
is non-missing. If `coverage` is missing, the target population size
(based on the population size of the region and age groups targeted)
will be calculated and the corresponding `coverage` calculated as
`doses` / `target_population`.

#### Vaccinating a cohort with no previous immunity

When vaccination is applied to a particular birth cohort that has no
immunity, the result is simply that the proportion of the cohort
receiving the vaccine will be immune from the time of the vaccination
onwards, i.e., the immunity for this cohort will be set to equal the
coverage of the vaccination activity in question. Due to the annual
time step, vaccination is assumed to take effect at the end of the
year in which it is implemented, so the immunity is updated from the
next year onwards.

#### Vaccinating a cohort with previous immunity

When a vaccination activity is applied to a cohort that has some
previous immunity, we need to make some assumptions about who will be
vaccinated in the new activity. There are 3 different options
implemented which are governed by the parameter `targeting`, one of
the input parameters to the function `apply_vacc()`. This parameter
can take the values `"targeted"`, `"random"` or `"correlated"`.

##### `"targeted"` targeting

The most effective way to implement a new vaccination activity is to
use `"targeted"` targeting, meaning that the vaccine is targeted at
previously non-immunised individuals. This means that the new immunity
of after the vaccination activity is simply the sum of the previous
immunity and the coverage of the current vaccination activity (capped
by 1 which indicates complete immunity of the cohort in question):

$$
\rm{immunity}_{\rm new} =
\min(\rm{immunity}_{\rm prev} + \rm{coverage}, 1)
$$

While this is not a realistic assumption in many settings, it can be
useful for instance in multi-year campaigns that target the same
region (but possibly proceed sub-region by sub-region) over several
years. This multi-year campaign would be coded as separate vaccination
activities for each year, using the option `targeting` = `"targeted"`.

##### `"random"` targeting

A reasonable first assumption might be to use `targeting` =
`"random"`, meaning that individuals will receive vaccination
irrespective of their previous immunity status. The immunity after the
new campaign is applied is calculated according to

$$
\rm{immunity}_{\rm new} =
\rm{coverage} + \rm{immunity}_{\rm prev} -
\rm{coverage}*\rm{immunity}_{\rm prev}
$$

##### `"correlated"` targeting

On the opposite end of the spectrum is the most pessimistic assumption
that might apply in situations where there is unequal access to
vaccination: under `"correlated"` targeting, people who have
previously been immunised get vaccinated first in the new vaccination
activity, and those previously not immune will only receive any
vaccine if the new coverage extends further:

$$
\rm{immunity}_{\rm new} =
\max(\rm{immunity}_{\rm prev}, \rm{coverage})
$$



Note that the order in which vaccination activities are applied to a
population does not matter under any of the `targeting` assumptions.








### The inverse

`vacc_from_immunity()`


## Summary & Visualisation

`calc_pop_immunity()`

`plot_pop_size()`, `plot_immunity()`

